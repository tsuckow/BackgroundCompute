<project name="Background Compute" default="javadoc_deploy_style" basedir=".">
	<target name="printinfo">
		<property environment="env" />
		<echo message="${env.BUILD_TAG}"/>
	</target>
	<target name="init" depends="printinfo">
		<property name="tst-dir" location="src/net/sf/backcomp/tests" />
		<property name="sourceDir" value="src" />
		<property name="outputDir" value="classes" />
		<property name="requiredDir" value="Required" />
		<property name="javadocDir" value="doc" />
		<property name="findbugs.home" value="lib/findbugs-1.3.5-rc1" />
		<property name="deployDir" value="/home/webmaster/public_html/updates/bc/dev" />
		<taskdef name="findbugs" classname="edu.umd.cs.findbugs.anttask.FindBugsTask" classpath="${findbugs.home}/lib/findbugs-ant.jar" />
		<taskdef resource="checkstyletask.properties">
			<classpath>
				<pathelement location="lib/checkstyle-all-5.0-beta01.jar"/>
				<pathelement location="lib/Defcon1Checks.jar"/>
			</classpath>
		</taskdef>
		
		<path id="classpath.base">
			<pathelement location="lib/junit-4.5.jar" />
			<pathelement location="lib/ant-junit.jar" />
		</path>
		<path id="classpath.test">
			<pathelement location="${outputDir}" />
			<path refid="classpath.base" />
		</path>
		
		<taskdef name="junit" classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask" classpathref="classpath.base"/>
	</target>
	<target name="clean" depends="init">
		<delete dir="${outputDir}" />
		<delete dir="${javadocDir}"/>
	</target>
	<target name="prepare" depends="clean">
		<mkdir dir="${outputDir}" />
	</target>
	<target name="compile" depends="prepare">
		<javac debug="true" srcdir="${sourceDir}" destdir="${outputDir}">
			<classpath refid="classpath.base"/>
		</javac>
	</target>
	
	<!-- ====================================================== -->
	<!-- JavaDocs -->
	<!-- ====================================================== -->
	<target name="docs" depends="compile,docs-init" description="Generate JavaDocs.">
	    <javadoc
	        destdir="${javadocDir}"
	        author="true"
	        version="true"
	        use="true"
	        windowtitle="${ant.project.name}"
	    	sourcepath="${sourceDir}"
	    	sourcefiles = "${sourceDir}/BC.java"
	    	packagenames = "net.sf.backcomp.*"
	        verbose="false"
	    >
	        <doctitle><![CDATA[<h1>${ant.project.name}</h1>]]></doctitle>
	        <bottom>
	            <![CDATA[<i>Copyright &#169; 2008 All Rights Reserved.</i>]]>
	        </bottom>
	        <!-- <tag name="todo" scope="all" description="To do:"/> -->
	    </javadoc>
	</target>
	<target name="docs-init">
	    <mkdir dir="${javadocDir}"/>
	</target>

	<target name="findbugs" depends="compile" description="Finds common programming mistakes.">
		<findbugs home="${findbugs.home}" output="xml" outputFile="findbugs.xml">
			<sourcePath path="${sourceDir}" />
			<class location="${outputDir}" />
		</findbugs>
	</target>

	<target name="checkstyle" depends="compile"
	 description="Checks that we are using consistant well formed style.">
		<checkstyle config="config_checkstyle.xml" failOnViolation="false">
			<fileset dir="src" includes="**/*.java"/>
			<formatter type="xml" toFile="checkstyle-result.xml"/>
		</checkstyle>
	</target>
	
	<!-- ====================================================== -->
	<!-- Verify we haven't broken anything. (We may only want to check the updater in the future before deploy) -->
	<!-- ====================================================== -->
	<target name="junit" depends="compile">
		<property name="report.dir"  value="test-reports"/>
		<mkdir dir="${report.dir}"/>
		<junit>
			<classpath refid="classpath.test" />
			<formatter type="xml" />
			<batchtest todir="${report.dir}">
				<fileset dir="${outputDir}">
					<include name="**/Test*.class" />
				</fileset>
			</batchtest>
		</junit>
	</target>
	
	<!-- ====================================================== -->
	<!-- Deploy to developement updater -->
	<!-- ====================================================== -->
	<target name="deploy" depends="compile,junit">
		<delete dir="${deployDir}" />
		<mkdir dir="${deployDir}" />
		<copy todir="${deployDir}">
			<fileset dir="${outputDir}">
				<exclude name="**/net/sf/backcomp/tests/" />
			</fileset>
			<fileset dir="${requiredDir}"/>
		</copy>
	</target>
	
	<!-- ====================================================== -->
	<!-- Batch: JavaDoc, Deploy -->
	<!-- ====================================================== -->
	<target name="javadoc_deploy" depends="deploy,docs">
	</target>
	
	<target name="style" depends="findbugs,checkstyle">
	</target>
	
	<!-- ====================================================== -->
	<!-- Batch: JavaDoc, Deploy, Style -->
	<!-- ====================================================== -->
	<target name="javadoc_deploy_style" depends="deploy,docs,style">
	</target>
</project>
